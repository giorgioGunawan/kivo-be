<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kivo AI | Admin Dashboard</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* --- Login Overlay --- */
        #loginOverlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .login-card h1 {
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 700;
        }

        .login-card p {
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        /* --- Layout --- */
        #mainApp {
            display: none;
            /* Hidden by default until login */
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
            overflow-x: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: #dbeafe;
            color: var(--primary);
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 99px;
            font-weight: 600;
        }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            gap: 8px;
            background: #f1f5f9;
            padding: 6px;
            border-radius: 12px;
            margin-bottom: 32px;
            width: fit-content;
            overflow-x: auto;
            max-width: 100%;
        }

        .tab {
            padding: 8px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* --- Panes --- */
        .pane {
            display: none;
        }

        .pane.active {
            display: grid;
        }

        #simulatorPane {
            grid-template-columns: minmax(300px, 380px) 1fr;
            gap: 24px;
        }

        @media (max-width: 1100px) {
            #simulatorPane {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .logs-container {
                order: 1;
                height: 500px;
            }
        }

        #databasePane {
            grid-template-columns: 1fr;
            width: 100%;
        }

        /* --- UI Elements --- */
        .sidebar {
            width: 100%;
            min-width: 0;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-muted);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.2s;
            font-size: 14px;
        }

        input:focus {
            border-color: var(--primary);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--primary-hover);
        }

        button.secondary {
            background: #f1f5f9;
            color: var(--text-main);
        }

        button.secondary:hover {
            background: #e2e8f0;
        }

        /* --- Logs Panel --- */
        .logs-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 250px);
        }

        #output {
            flex-grow: 1;
            overflow-y: auto;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 14px;
            max-width: 100%;
            word-break: break-word;
        }

        .log-entry {
            margin-bottom: 16px;
            border-bottom: 1px solid #edf2f7;
            padding-bottom: 12px;
        }

        .log-timestamp {
            color: var(--text-muted);
            font-size: 11px;
            margin-bottom: 4px;
        }

        /* --- Table View --- */
        .table-browser {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .table-controls {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            background: white;
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .table-controls>div {
            flex-grow: 0;
            min-width: 200px;
        }

        .table-scroll {
            overflow-x: auto;
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #f1f5f9;
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--text-main);
        }

        tr:hover td {
            background-color: #f8fafc;
        }

        /* Media */
        .media-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        video {
            outline: none;
        }
    </style>
</head>

<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h1>Kivo Admin</h1>
            <p>Please enter the administrator password</p>
            <input type="password" id="entryPassword" placeholder="Password" style="text-align:center" />
            <button onclick="checkAdminLogin()" style="width:100%">Enter Dashboard</button>
            <div id="loginError" style="color:#ef4444; margin-top:10px; font-size:14px; display:none">Incorrect Password
            </div>
        </div>
    </div>

    <div id="mainApp">
        <header>
            <div class="logo">
                ‚ú® Kivo AI <span class="badge">PRO</span>
            </div>
            <div id="userInfo" style="font-size: 14px; color: var(--text-muted)">Not logged in</div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('simulator')">Simulator & Logs</div>
            <div class="tab" onclick="switchTab('queue')">Job Queue</div>
            <div class="tab" onclick="switchTab('database')">Database Browser</div>
            <div class="tab" onclick="switchTab('systemLogs')">Cron Logs</div>
        </div>

        <!-- Simulator Pane -->
        <div id="simulatorPane" class="pane active">

            <div class="sidebar">
                <!-- Auth Card -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <h3>üîë Session</h3>
                    </div>
                    <label>User JWT Token</label>
                    <input type="text" id="userToken" placeholder="Auto-fills on login" />
                    <button class="secondary" onclick="loginMockUser()" style="width:100%">Login as Mock User</button>
                </div>

                <!-- Simulation Tools -->
                <div class="card">
                    <div class="card-header">
                        <h3>üß™ Simulation</h3>
                    </div>
                    <label>Action</label>
                    <select id="actionSelect" onchange="updateForm()">
                        <optgroup label="User Simulation">
                            <option value="getBalance">üí≥ Check My Balance</option>
                            <option value="createJob" selected>üé® Create New Generation</option>
                            <option value="getJob">üëÄ Check Job Status</option>
                            <option value="getLedger">üìú View History</option>
                            <option value="verifySub">‚úÖ Verify Subscription</option>
                        </optgroup>
                        <optgroup label="Admin Tools">
                            <option value="addCredits">üí∞ Manage User Credits</option>
                            <option value="checkUser">üë§ Check User Status</option>
                            <option value="getParams">‚öôÔ∏è System Settings</option>
                            <option value="setParams">‚úèÔ∏è Change Settings</option>
                        </optgroup>
                    </select>

                    <div id="actionDescription"
                        style="font-size: 13px; color: var(--text-muted); padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 20px;">
                        Loading...
                    </div>

                    <div id="formContainer"></div>

                    <button onclick="executeAction()" style="width:100%">Run Request</button>
                </div>
            </div>

            <div class="card logs-container">
                <div class="card-header">
                    <h3>üìú Console Logs</h3>
                    <button class="secondary" style="padding: 5px 15px; font-size: 12px;" onclick="clearLogs()">Clear
                        Logs</button>
                </div>
                <div id="output">
                    <div style="color: #64748b; font-style: italic;">Wait for activity...</div>
                </div>
            </div>
        </div>

        <!-- Queue Pane -->
        <div id="queuePane" class="pane">
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h3>üìä Queue Overview</h3>
                    <button class="secondary" onclick="fetchQueueStatus()">Refresh Queue</button>
                    <button style="background: #fee2e2; color: #991b1b; border: 1px solid #fecaca"
                        onclick="clearFailedJobs()">Clear Failed Jobs</button>
                </div>
                <div id="queueStats"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 16px; text-align: center;">
                    Loading...
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üöÄ Active, Waiting & Failed Jobs (Top 50)</h3>
                </div>
                <div class="table-scroll">
                    <table id="queueTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>State</th>
                                <th>Attempts</th>
                                <th>Created</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="queueTableBody">
                            <tr>
                                <td colspan="6" style="text-align:center; padding:20px">No jobs found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Database Pane -->
        <div id="databasePane" class="pane">
            <!-- ... (existing db content) ... -->
            <div class="table-browser">
                <div class="table-controls">
                    <div>
                        <label>Select Table</label>
                        <select id="dbTableSelect" style="margin-bottom:0">
                            <option value="users">Users</option>
                            <option value="credit_balances">Balances</option>
                            <option value="credit_ledger">Ledger (Activity)</option>
                            <option value="jobs" selected>Jobs</option>
                            <option value="subscriptions">Subscriptions</option>
                            <option value="idempotency_keys">Idempotency Keys</option>
                            <option value="admin_config">Config</option>
                            <option value="external_events">External Events</option>
                        </select>
                    </div>
                    <button onclick="viewTable()" style="height:42px">üîÑ Refresh Data</button>
                    <button style="height:42px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca"
                        onclick="cleanupFailedDbJobs()">üßπ Cleanup Failed Jobs</button>
                </div>

                <div class="card table-view" style="padding:0; overflow:hidden;">
                    <div class="table-scroll" id="dbOutput">
                        <div style="padding:40px; text-align:center; color: var(--text-muted)">Click refresh to load
                            data</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Logs Pane -->
        <div id="systemLogsPane" class="pane">
            <div class="card">
                <div class="card-header">
                    <h3>üìú Cron Logs</h3>
                    <div style="display:flex; gap:10px">
                        <button class="secondary" onclick="runCronCleanup()">‚ö° Run Cleanup Task</button>
                        <button class="secondary" onclick="fetchSystemLogs()">Refresh Logs</button>
                    </div>
                </div>
                <div class="table-scroll">
                    <table id="systemLogsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Event</th>
                                <th>Level</th>
                                <th>Message</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="systemLogsBody">
                            <tr>
                                <td colspan="5" style="text-align:center; padding:20px">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let adminPassword = '';

        async function runCronCleanup() {
            if (!confirm('Run the subscription cleanup task manually? This will verify expired active subscriptions with Apple.')) return;
            try {
                const btn = event.target;
                const oldText = btn.textContent;
                btn.textContent = 'Running...';
                btn.disabled = true;

                const res = await fetch(`${API_URL}/admin/cron/run-cleanup`, {
                    method: 'POST',
                    headers: { 'x-admin-password': adminPassword }
                });
                const data = await res.json();

                alert(data.success ? 'Task Completed Successfully' : 'Task Failed');
                fetchSystemLogs();

                btn.textContent = oldText;
                btn.disabled = false;
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // --- Auth Gateway ---
        function checkAdminLogin() {
            const passInput = document.getElementById('entryPassword');
            const password = passInput.value;

            // For MVP we just use it. In a real app we'd verify with a ping.
            adminPassword = password;

            // Visual feedback
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Try to load initial data
            updateForm();
            // viewTable(); // Don't auto load table, maybe too heavy
            fetchQueueStatus();

            // Clear inputs to prompt fresh upload (since Railway wipes files on deploy)
            setTimeout(() => {
                const imgInput = document.getElementById('jobInputImage');
                if (imgInput) imgInput.value = '';
                const status = document.getElementById('uploadStatus');
                if (status) status.textContent = ' (New upload required)';
            }, 100);
        }

        // --- Tabs ---
        function switchTab(tabId) {
            // Remove active from all tabs and panes
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));

            // Activate clicked tab via event (if available) or by matching text/content
            // Better: Find tab by index or attribute. Simple way:
            const tabs = document.querySelectorAll('.tab');
            if (tabId === 'simulator') tabs[0].classList.add('active');
            if (tabId === 'queue') tabs[1].classList.add('active');
            if (tabId === 'database') tabs[2].classList.add('active');
            if (tabId === 'systemLogs') tabs[3].classList.add('active');

            const pane = document.getElementById(`${tabId}Pane`);
            if (pane) pane.classList.add('active');

            if (tabId === 'queue') fetchQueueStatus();
            if (tabId === 'systemLogs') fetchSystemLogs();
        }

        // --- System Logs ---
        async function fetchSystemLogs() {
            const tbody = document.getElementById('systemLogsBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#64748b">Loading entries...</td></tr>';
            try {
                const res = await fetch(`${API_URL}/admin/logs?limit=50`, {
                    headers: { 'x-admin-password': adminPassword }
                });
                const logs = await res.json();

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#64748b">No logs found</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => {
                    const date = new Date(log.created_at).toLocaleString();
                    let levelColor = '#3b82f6'; // info
                    if (log.level === 'warn') levelColor = '#f59e0b';
                    if (log.level === 'error') levelColor = '#ef4444';

                    return `
                        <tr>
                            <td style="font-size:12px; white-space:nowrap; color:#64748b">${date}</td>
                            <td style="font-weight:600; font-size:13px">${log.event_type}</td>
                            <td><span style="background:${levelColor}20; color:${levelColor}; padding:2px 6px; border-radius:4px; font-size:11px; font-weight:700; text-transform:uppercase">${log.level}</span></td>
                            <td>${log.message}</td>
                            <td>
                                <div style="font-family:monospace; font-size:11px; max-width:300px; max-height:60px; overflow:auto; background:#f1f5f9; padding:4px; border-radius:4px">
                                    ${JSON.stringify(log.details || {}, null, 2)}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center">Error: ${e.message}</td></tr>`;
            }
        }

        // --- Queue Logic ---
        async function fetchQueueStatus() {
            const statsDiv = document.getElementById('queueStats');
            const tbody = document.getElementById('queueTableBody');

            // statsDiv.innerHTML = 'Loading...'; 

            try {
                const res = await fetch(`${API_URL}/admin/queue`, {
                    headers: { 'x-admin-password': adminPassword }
                });
                const data = await res.json();

                if (data.counts) {
                    // Render Stats
                    const statBox = (label, val, color) => `
                        <div style="background: ${color}10; padding: 12px; border-radius: 8px; border: 1px solid ${color}30">
                            <div style="font-size:24px; font-weight:800; color:${color}">${val}</div>
                            <div style="font-size:12px; font-weight:600; color:${color}; text-transform:uppercase">${label}</div>
                        </div>
                    `;

                    statsDiv.innerHTML = `
                        ${statBox('Waiting', data.counts.waiting, '#f59e0b')}
                        ${statBox('Active', data.counts.active, '#3b82f6')}
                        ${statBox('Completed', data.counts.completed, '#10b981')}
                        ${statBox('Failed', data.counts.failed, '#ef4444')}
                        ${statBox('Delayed', data.counts.delayed, '#6366f1')}
                    `;
                }

                if (data.jobs && Array.isArray(data.jobs)) {
                    if (data.jobs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#64748b">No active or waiting jobs</td></tr>';
                    } else {
                        tbody.innerHTML = data.jobs.map(job => {
                            const date = new Date(job.timestamp).toLocaleString();
                            const duration = job.processedOn ? ((job.finishedOn || Date.now()) - job.processedOn) / 1000 + 's' : '-';

                            let stateColor = '#64748b';
                            if (job.state === 'active') stateColor = '#3b82f6';
                            if (job.state === 'waiting') stateColor = '#f59e0b';
                            if (job.state === 'failed') stateColor = '#ef4444';
                            if (job.state === 'completed') stateColor = '#10b981';

                            let details = '';
                            if (job.state === 'failed' && job.failedReason) {
                                details = `<div style="color: #ef4444; font-size: 10px; margin-top: 4px; max-width: 200px; word-wrap: break-word;">${job.failedReason}</div>`;
                            }

                            return `
                                <tr>
                                    <td><code style="font-size:11px">${job.id}</code></td>
                                    <td><span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-size:11px; font-weight:600">ID ${job.userId}</span> <div style="font-size:10px; color:#64748b">${job.data?.providerName || ''}</div></td>
                                    <td>
                                        <span style="color:${stateColor}; font-weight:700; text-transform:capitalize">‚óè ${job.state}</span>
                                        ${details}
                                    </td>
                                    <td>${job.attempts}</td>
                                    <td style="font-size:12px">${date}</td>
                                    <td style="font-size:12px">${duration}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }

            } catch (e) {
                statsDiv.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
            }
        }

        async function clearFailedJobs() {
            if (!confirm('Are you sure you want to clear ALL failed jobs from the queue?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/queue/clear-failed`, {
                    method: 'POST',
                    headers: { 'x-admin-password': adminPassword }
                });
                const data = await res.json();
                if (data.success) {
                    alert('Queue cleared');
                    fetchQueueStatus();
                } else {
                    alert('Failed to clear queue: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function cleanupFailedDbJobs() {
            if (!confirm('Are you sure you want to PERMANENTLY delete all failed jobs from the database?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/db/cleanup-failed-jobs`, {
                    method: 'POST',
                    headers: { 'x-admin-password': adminPassword }
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Cleanup successful. Deleted ${data.count} jobs.`);
                    viewTable();
                } else {
                    alert('Failed to cleanup: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }


        // --- Application State ---
        let currentUser = null;

        async function loginMockUser() {
            log('Logging in mock user...');
            try {
                const res = await fetch(`${API_URL}/auth/apple`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identityToken: 'mock_token' })
                });
                const data = await res.json();
                if (data.token) {
                    document.getElementById('userToken').value = data.token;
                    currentUser = data.user;
                    document.getElementById('userInfo').textContent = `Logged in: User ID ${data.user.id}`;
                    log('Login Successful!', data);
                } else {
                    log('Login Failed', data);
                }
            } catch (e) {
                log('Error logging in', e);
            }
        }

        // --- Forms Setup ---
        const forms = {
            getParams: '',
            setParams: `
                <label>Key</label><input type="text" id="configKey" placeholder="e.g. weekly_allocation">
                <label>Value (JSON)</label><input type="text" id="configValue" placeholder="e.g. 1000">
            `,
            addCredits: `
                <label>User ID</label><input type="text" id="creditUserId" placeholder="User ID">
                <label>Amount (Negative to deduct)</label><input type="number" id="creditAmount" value="500">
                <label>Reason</label>
                <select id="creditReason">
                    <option value="admin_adjust">admin_adjust</option>
                    <option value="refund_failure">refund_failure</option>
                    <option value="refund_timeout">refund_timeout</option>
                    <option value="provider_error">provider_error</option>
                    <option value="purchase">purchase</option>
                    <option value="refresh">refresh</option>
                    <option value="generation">generation</option>
                    <option value="expiry">expiry</option>
                </select>
                <label>Pool</label>
                <select id="creditPool">
                    <option value="weekly">Weekly</option>
                    <option value="purchased">Purchased</option>
                </select>
            `,
            createJob: `
                <label>Media Type</label>
                <select id="jobMetaType">
                    <option value="image">Image</option>
                    <option value="video">Video</option>
                </select>
                
                <label>Input Image URL (Optional)</label>
                <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                    <input type="text" id="jobInputImage" placeholder="https://..." style="margin-bottom:0" />
                    <input type="file" id="imageUpload" style="display: none;" onchange="uploadFile()" />
                    <button class="secondary" onclick="document.getElementById('imageUpload').click()" style="padding:0 15px">üì§</button>
                    <span id="uploadStatus" style="font-size: 11px; align-self: center;"></span>
                </div>

                <label>Model (Optional)</label>
                <select id="jobModel">
                    <option value="">Default (Auto)</option>
                    <option value="google/nano-banana-edit">Nano Banana Edit (Google)</option>
                    <option value="grok-imagine/text-to-image">Grok Imagine (Text-to-Image)</option>
                    <option value="grok-imagine/image-to-image">Grok Imagine (Image-to-Image)</option>
                    <option value="kling-v1">Kling v1 (Video/Image Edit)</option>
                    <option value="flux-pro/v1.1">Flux Pro 1.1</option>
                </select>

                <label>Prompt</label>
                <textarea id="jobParams" rows="3">A futuristic city</textarea>
                
                <div id="pollingIndicator" style="display:none; margin-top:10px; font-size:12px; color:var(--primary); font-weight:600;">
                    ‚è≥ Polling for result...
                </div>
            `,
            getBalance: '',
            getLedger: '',
            getJob: `<label>Job ID</label><input type="text" id="jobId" placeholder="Job ID">`,
            verifySub: `<label>Transaction ID</label><input type="text" id="subTxId" value="1000000">`,
            checkUser: `<label>User ID</label><input type="text" id="checkUserId" placeholder="User ID">`
        };

        const actionDescriptions = {
            getParams: "Fetch current system configuration constants.",
            setParams: "Overwrite a configuration key in the database.",
            addCredits: "Add or deduct credits for a user (use negative value to remove).",
            createJob: "Simulate a user creating a new AI job. It will auto-poll for the result!",
            getBalance: "Get the credit balance for the authenticated simulation user.",
            getLedger: "See the full history of credit transactions for the user.",
            getJob: "Fetch detail and result for a specific job.",
            verifySub: "Simulate an Apple receipt verification call.",
            checkUser: "Check subscription status, expiration, and credit balance for a user."
        };

        function updateForm() {
            const action = document.getElementById('actionSelect').value;
            document.getElementById('actionDescription').textContent = actionDescriptions[action];
            document.getElementById('formContainer').innerHTML = forms[action] || '';

            if (action === 'addCredits' && currentUser) {
                setTimeout(() => document.getElementById('creditUserId').value = currentUser.id, 0);
            }

            if (action === 'createJob') {
                const status = document.getElementById('uploadStatus');
                if (status) status.textContent = ' (Fresh upload recommended)';
            }
        }

        // --- Commands ---
        async function executeAction() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ ...';

            const action = document.getElementById('actionSelect').value;
            const token = document.getElementById('userToken').value;

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'x-admin-password': adminPassword
            };

            let url, method, body;

            try {
                switch (action) {
                    case 'getParams': method = 'GET'; url = '/admin/config'; break;
                    case 'setParams':
                        method = 'POST'; url = '/admin/config';
                        body = { key: document.getElementById('configKey').value, value: JSON.parse(document.getElementById('configValue').value) };
                        break;
                    case 'addCredits':
                        method = 'POST'; url = '/admin/credits/add';
                        const reason = document.getElementById('creditReason').value || 'admin_adjustment';
                        body = {
                            userId: document.getElementById('creditUserId').value,
                            delta: document.getElementById('creditAmount').value,
                            poolType: document.getElementById('creditPool').value,
                            reason: reason
                        };
                        break;
                    case 'createJob':
                        method = 'POST'; url = '/jobs';
                        body = { media_type: document.getElementById('jobMetaType').value, prompt: document.getElementById('jobParams').value };
                        if (document.getElementById('jobModel').value) body.model = document.getElementById('jobModel').value;
                        if (document.getElementById('jobInputImage').value) body.input_image_url = document.getElementById('jobInputImage').value;
                        headers['Idempotency-Key'] = crypto.randomUUID();
                        break;
                    case 'getBalance': method = 'GET'; url = '/credits/balance'; break;
                    case 'getLedger': method = 'GET'; url = '/credits/ledger'; break;
                    case 'getJob': url = `/jobs/${document.getElementById('jobId').value}`; method = 'GET'; break;
                    case 'verifySub': method = 'POST'; url = '/auth/subscription/verify'; body = { originalTransactionId: document.getElementById('subTxId').value }; break;
                    case 'checkUser': method = 'GET'; url = `/admin/user/${document.getElementById('checkUserId').value}/subscription`; break;
                }

                log(`üöÄ ${action === 'createJob' ? 'Job Request Started' : 'Executing ' + action}...`);
                const res = await fetch(API_URL + url, { method, headers, body: body ? JSON.stringify(body) : undefined });
                const data = await res.json();

                if (res.status >= 400) {
                    log(`‚ùå Request Failed (${res.status})`, data);
                    return;
                }

                if (action === 'getBalance') {
                    const balance = `Weekly: ${data.weekly_remaining} | Purchased: ${data.purchased_remaining}`;
                    log(`‚úÖ Balance Found: ${balance}`, data);
                } else if (action === 'getLedger') {
                    log(`‚úÖ Transaction History (${Array.isArray(data) ? data.length : 0} entries)`, data);
                } else if (action === 'addCredits') {
                    log(`‚úÖ Credits added successfully`, data);
                    viewTable(); // Auto refresh the balances table
                } else if (action !== 'createJob') {
                    log(`‚úÖ Success`, data);
                }

                // If the response is a job and it's already completed (unlikely for new jobs but good for getJob)
                if (data.result_url) {
                    renderLogImage(data.result_url);
                }

                // If it's a new job, start polling!
                if (action === 'createJob' && data.jobId) {
                    startAutoPolling(data.jobId, token);
                }
            } catch (err) {
                log('‚ùå Request Error', err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // --- Polling Logic ---
        async function startAutoPolling(jobId, token) {
            const indicator = document.getElementById('pollingIndicator');
            if (indicator) indicator.style.display = 'block';

            let attempts = 0;
            const poll = setInterval(async () => {
                attempts++;
                if (attempts > 30) {
                    clearInterval(poll);
                    if (indicator) indicator.style.display = 'none';
                    log('‚è≥ Polling timed out after 60s');
                    return;
                }

                try {
                    const res = await fetch(`${API_URL}/jobs/${jobId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();

                    if (data.status === 'completed') {
                        clearInterval(poll);
                        if (indicator) indicator.style.display = 'none';
                        log(`‚ú® Generation Complete!`);
                        renderLogImage(data.result_url);
                        viewTable(); // Refresh the table too
                    } else if (data.status === 'failed') {
                        clearInterval(poll);
                        if (indicator) indicator.style.display = 'none';
                        log(`‚ùå Job Failed`, data.error || data);
                    }
                } catch (e) {
                    // Ignore transient errors
                }
            }, 3000);
        }

        // --- Database Loader ---
        async function viewTable() {
            const btn = event.target;
            const originalText = btn.textContent;
            if (btn.tagName === 'BUTTON') {
                btn.disabled = true;
                btn.textContent = '‚è≥ ...';
            }

            const table = document.getElementById('dbTableSelect').value;
            const output = document.getElementById('dbOutput');
            output.innerHTML = '<div style="padding:40px; text-align:center;">Loading data...</div>';

            try {
                const res = await fetch(`${API_URL}/admin/db/${table}`, {
                    headers: { 'x-admin-password': adminPassword }
                });
                const data = await res.json();

                if (res.status === 200 && Array.isArray(data)) {
                    if (data.length === 0) {
                        output.innerHTML = '<div style="padding:40px; text-align:center; color:#64748b">Table is empty</div>';
                        return;
                    }

                    const headers = Object.keys(data[0]);
                    let html = '<table><thead><tr>';
                    headers.forEach(h => html += `<th>${h}</th>`);
                    html += '</tr></thead><tbody>';

                    data.forEach(row => {
                        html += '<tr>';
                        headers.forEach(h => {
                            let val = row[h];

                            // Convert dates for specific columns to Australian Time
                            if (val && (h === 'expires_at' || h === 'last_verified_at')) {
                                try {
                                    val = new Date(val).toLocaleString('en-AU', {
                                        timeZone: 'Australia/Sydney',
                                        year: 'numeric', month: 'short', day: 'numeric',
                                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                                        hour12: true
                                    });
                                } catch (e) { }
                            }
                            if (val && typeof val === 'string' && (val.startsWith('http') || val.startsWith('/uploads'))) {
                                const isImage = /\.(jpg|jpeg|png|webp|gif|avif)($|\?)/i.test(val) || h.includes('image') || h.includes('url');
                                const isVideo = /\.(mp4|webm|mov)($|\?)/i.test(val) || h.includes('video');

                                if (isImage) {
                                    val = `<a href="${val}" target="_blank"><img src="${val}" class="media-thumb" /></a>`;
                                } else if (isVideo) {
                                    val = `<video src="${val}" class="media-thumb" controls muted></video><br><a href="${val}" target="_blank" style="font-size: 10px; color: var(--primary)">Open ‚Üó</a>`;
                                } else {
                                    val = `<a href="${val}" target="_blank" style="color: var(--primary); font-size:12px; word-break: break-all;">${val}</a>`;
                                }
                            } else if (typeof val === 'object' && val !== null) {
                                val = `<code style="font-size:10px; color:#c026d3">${JSON.stringify(val)}</code>`;
                            }
                            html += `<td>${val === null ? '<span style="color:#cbd5e1">null</span>' : val}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                    output.innerHTML = html;
                } else {
                    output.innerHTML = `<div style="padding:40px; text-align:center; color:#ef4444">Error: ${data.error || 'Fetch failed'}</div>`;
                }
            } catch (err) {
                output.innerHTML = `<div style="padding:40px; text-align:center; color:#ef4444">Error: ${err.message}</div>`;
            } finally {
                if (btn && btn.tagName === 'BUTTON') {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        // --- Logging ---
        function log(msg, data) {
            const output = document.getElementById('output');
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const time = new Date().toLocaleTimeString();

            // Check if successful or failure for title color
            const isError = msg.includes('Failed') || msg.includes('Error');
            const color = isError ? '#ef4444' : '#0f172a';

            entry.innerHTML = `
                <div class="log-timestamp">${time}</div>
                <div style="font-weight:700; color: ${color}; margin-bottom:8px; font-size: 15px;">${msg}</div>
            `;

            // Always show details if data is present
            if (data) {
                const isObject = typeof data === 'object' && data !== null;
                const pre = document.createElement('pre');
                pre.style.margin = '0';
                pre.style.color = isError ? '#ef4444' : '#475569';
                pre.style.background = isError ? '#fef2f2' : '#f1f5f9';
                pre.style.padding = '12px';
                pre.style.borderRadius = '8px';
                pre.style.border = isError ? '1px solid #fee2e2' : '1px solid #e2e8f0';
                pre.style.fontSize = '12px';
                pre.style.whiteSpace = 'pre-wrap';
                pre.style.overflowX = 'auto';
                pre.textContent = isObject ? JSON.stringify(data, null, 2) : data;
                entry.appendChild(pre);
            }

            output.prepend(entry);
        }

        function renderLogImage(url) {
            const output = document.getElementById('output');
            const img = document.createElement('img');
            img.src = url;
            img.style.width = '100%';
            img.style.maxWidth = '600px';
            img.style.marginTop = '15px';
            img.style.borderRadius = '12px';
            img.style.boxShadow = 'var(--shadow-lg)';
            img.style.border = '1px solid var(--border)';
            output.firstChild.appendChild(img);
        }

        function clearLogs() {
            document.getElementById('output').innerHTML = '<div style="color: #64748b; font-style: italic;">Wait for activity...</div>';
        }

        async function uploadFile() {
            const fileInput = document.getElementById('imageUpload');
            const status = document.getElementById('uploadStatus');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);
            status.textContent = '‚è≥ ...';

            try {
                const res = await fetch(`${API_URL}/admin/upload`, {
                    method: 'POST',
                    headers: { 'x-admin-password': adminPassword },
                    body: formData
                });
                const data = await res.json();
                if (data.url) {
                    document.getElementById('jobInputImage').value = data.url;
                    status.textContent = '‚úÖ';
                } else {
                    status.textContent = '‚ùå';
                }
            } catch (e) {
                status.textContent = '‚ùå';
            }
        }
    </script>
</body>

</html>